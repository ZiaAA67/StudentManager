{% extends 'admin/master.html' %}

{% block body %}
{% block content %}
<div class="card align-items-center">
    <h1 class="text-center mt-2" style="font-weight: bold;">BÁO CÁO TỔNG KẾT MÔN HỌC</h1>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <div class="mt-4 mb-4" style="width: 80%;">
        <form method="GET" action="{{ url_for('statsview.index') }}">
            <div class="row">
                <div class="col-md-4">
                    <label for="year" class="form-label">Năm học:</label>
                    <select id="year" name="year" class="form-control" required>
                        <option value="2024" {% if selected_year=="2024" %}selected{% endif %}>2024</option>
                        <option value="2025" {% if selected_year=="2025" %}selected{% endif %}>2025</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label for="semester" class="form-label">Học kỳ:</label>
                    <select id="semester" name="semester" class="form-control" required>
                        <option value="1" {% if selected_semester=="1" %}selected{% endif %}>Học kỳ 1</option>
                        <option value="2" {% if selected_semester=="2" %}selected{% endif %}>Học kỳ 2</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label for="grade" class="form-label">Khối:</label>
                    <select id="grade" name="grade" class="form-control" required onchange="loadSubjects()">
                        <option value="" {% if not selected_grade %}selected{% endif %}>Chọn khối</option>
                        <option value="10" {% if selected_grade=="10" %}selected{% endif %}>Khối 10</option>
                        <option value="11" {% if selected_grade=="11" %}selected{% endif %}>Khối 11</option>
                        <option value="12" {% if selected_grade=="12" %}selected{% endif %}>Khối 12</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label for="subject" class="form-label">Môn:</label>
                    <select id="subject" name="subject" class="form-control" {% if not selected_grade %}disabled{% endif
                            %} required>
                        {% for subject in subjects %}
                        <option value="{{ subject.id }}" {% if selected_subject== subject.id %}selected{% endif %}>
                            {{ subject.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <button type="submit" class="btn btn-primary mt-3">Xem Báo Cáo</button>
        </form>
    </div>

    <table class="table table-bordered mt-4" style="width: 80%;">
        <thead class="table-dark text-center">
        <tr>
            <th>STT</th>
            <th>Lớp</th>
            <th>Sĩ số</th>
            <th>Số lượng đạt</th>
            <th>Tỷ lệ (%)</th>
        </tr>
        </thead>
        <tbody>
        {% if statistics %}
        {% for s in statistics %}
        <tr class="text-center">
            <td>{{ s[0] }}</td>
            <td>{{ s[1] }}</td>
            <td>{{ s[2] }}</td>
            <td>{{ s[3] }}</td>
            <td>{{ s[4] | round(2) }}%</td>
        </tr>
        {% endfor %}
        {% else %}
        <tr>
            <td colspan="5" class="text-center">Không có dữ liệu</td>
        </tr>
        {% endif %}
        </tbody>
    </table>

    {% if statistics %}
    <div class="mt-4" style="width: 80%;">
        <canvas id="reportChart"></canvas>
    </div>
    {% endif %}
</div>

<script>
    function loadSubjects() {
        var grade = document.getElementById('grade').value;
        var subjectSelect = document.getElementById('subject');
        subjectSelect.disabled = !grade;

        if (grade) {
            fetch('/get_subjects/' + grade)
                .then(response => response.json())
                .then(data => {
                    subjectSelect.innerHTML = '';
                    var defaultOption = document.createElement('option');
                    defaultOption.text = 'Chọn môn';
                    subjectSelect.add(defaultOption);

                    data.forEach(function (subject) {
                        var option = document.createElement('option');
                        option.value = subject.id;
                        option.text = subject.name;
                        subjectSelect.add(option);
                    });
                });
        } else {
            subjectSelect.innerHTML = '';
            var defaultOption = document.createElement('option');
            defaultOption.text = 'Chọn khối trước';
            subjectSelect.add(defaultOption);
        }
    }

    {% if statistics %}
    var ctx = document.getElementById('reportChart').getContext('2d');
    var reportChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: [
                {% for s in statistics %}
                    '{{ s[1] }}' {% if not loop.last %}, {% endif %}
                {% endfor %}
            ],
            datasets: [{
                label: 'Tỷ lệ đạt (%)',
                data: [
                    {% for s in statistics %}
                        {{ s[4] | round(2) }}{% if not loop.last %}, {% endif %}
                    {% endfor %}
                ],
                backgroundColor: 'rgba(54, 162, 235, 0.2)',
                borderColor: 'rgba(54, 162, 235, 1)',
                borderWidth: 1
            }]
        },
        options: {
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
{% endif %}

</script>
{% endblock %}
{% endblock %}
